<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factor A & B Calculator</title>
    <!-- Library to read XLSX files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 35px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.4em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.15em;
        }

        .calculator-form {
            padding: 45px;
        }
        
        .data-loader {
            background: #eef2f7;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #1abc9c;
            text-align: center;
        }
        
        .data-loader h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .status-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .file-status {
            font-style: italic;
            color: #555;
            font-size: 0.9em;
            padding: 5px 15px;
            border-radius: 20px;
            background: #e0e6ec;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-status.loading {
            color: #2980b9;
            background: #d4e6f1;
        }
        
        .file-status.loaded {
            color: #27ae60;
            background: #d4f1d4;
        }
        
        .file-status.error {
            color: #e74c3c;
            background: #f8d7da;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '⚙️';
            margin-right: 10px;
            font-size: 1.2em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .input-group {
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
        }

        input, select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1.05em;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 45px;
        }

        .material-info {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 30px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .calculate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
        }
        
        .results {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border-radius: 12px;
            padding: 35px;
            margin-top: 30px;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .results.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-content {
            position: relative;
            z-index: 1;
        }

        .results h3 {
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 700;
        }

        .factor-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 25px;
        }
        
        .factor-card {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .factor-label {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .factor-value {
            font-size: 2.2em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        .results-table th, .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            text-align: left;
        }

        .results-table th {
            font-weight: 700;
            background: rgba(255,255,255,0.15);
            font-size: 1em;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            display: none;
            position: relative;
        }

        .warning.show {
            display: block;
            animation: pulse 0.5s ease;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .warning-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            .factor-results {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Factor A & B Calculator</h1>
                <p>Calculate factors based on material properties and dimensions</p>
            </div>
        </div>

        <form class="calculator-form" id="calculatorForm">
            <div class="data-loader">
                <h2>Data Status</h2>
                <div class="status-container">
                    <div id="statusA" class="file-status loaded">Factor A: Loaded</div>
                    <div id="statusB" class="file-status">Factor B: Awaiting selection...</div>
                </div>
            </div>

            <div class="input-section">
                <h2 class="section-title">Input Parameters</h2>
                
                <div class="input-grid">
                    <div class="input-group">
                       <label for="materialType (ASME Section II Table 1A)">Material Type</label>
                        <select id="materialType" required>
                            <option value="">Select Material Type</option>
                            <option value="CS-1">CS-1 - Carbon Steel Grade 1</option>
                            <option value="CS-2">CS-2 - Carbon Steel Grade 2</option>
                            <option value="HA-1">HA-1 - High Alloy Grade 1</option>
                       </select>
                        <div class="material-info" id="materialInfo"></div>
                    </div>

                    <div class="input-group">
                        <label for="outsideDiameter">Outside Diameter (OD) (mm)</label>
                        <input type="number" id="outsideDiameter" step="0.001" placeholder="Enter OD" required>
                    </div>

                    <div class="input-group">
                        <label for="thickness">Thickness (t) (mm)</label>
                        <input type="number" id="thickness" step="0.001" placeholder="Enter thickness" required>
                    </div>

                    <div class="input-group">
                        <label for="length">Length (L) (mm)</label>
                        <input type="number" id="length" step="0.001" placeholder="Enter length" required>
                    </div>

                    <div class="input-group">
                        <label for="temperature">Temperature (°C)</label>
                        <input type="number" id="temperature" step="0.1" placeholder="Enter temperature" required>
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtn" disabled>Calculate Factor A & B</button>

            <div class="results" id="results">
                <div class="results-content">
                    <h3>Calculation Results</h3>
                    
                    <div class="factor-results">
                        <div class="factor-card">
                            <div class="factor-label">Factor A</div>
                            <div class="factor-value" id="factorAResult">-</div>
                        </div>
                        <div class="factor-card">
                            <div class="factor-label">Factor B</div>
                            <div class="factor-value" id="factorBResult">-</div>
                        </div>
                    </div>

                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Material Type</td><td id="tableMaterial">-</td><td>-</td></tr>
                            <tr><td>Outside Diameter (OD)</td><td id="tableOD">-</td><td>mm</td></tr>
                            <tr><td>Thickness (t)</td><td id="tableThickness">-</td><td>mm</td></tr>
                            <tr><td>Length (L)</td><td id="tableLength">-</td><td>mm</td></tr>
                            <tr><td>Temperature</td><td id="tableTemperature">-</td><td>°C</td></tr>
                            <tr><td>$D/t$ Ratio</td><td id="tableDTRatio">-</td><td>-</td></tr>
                            <tr><td>$L/D$ Ratio</td><td id="tableLDRatio">-</td><td>-</td></tr>
                            <tr><td>Factor A</td><td id="tableFactorA">-</td><td>-</td></tr>
                            <tr><td>Factor B</td><td id="tableFactorB">-</td><td>-</td></tr>
                        </tbody>
                    </table>
               </div>
            </div>

            <div class="warning" id="warning">
                <span class="warning-icon">⚠️</span>
                <strong>Warning:</strong> <span id="warningText"></span>
            </div>
        </form>
    </div>

    <script>
        // --- EMBEDDED CSV DATA AS STRINGS ---
        // These strings are generated from the CSV files you uploaded.
        // This avoids network requests and ensures the app works immediately.
        const factorA_csv_content = `"Y : D/t,X : L/D",0.05,0.054,0.06,0.07,0.074,0.08,0.088,0.09,0.1,0.12,0.14,0.16,0.2,0.24,0.3,0.34,0.4,0.5,0.56,0.6,0.7,0.74,0.8,1,1.2,1.4,1.6,2,2.2,2.4,2.6,3,3.4,4,4.2,4.4,5,5.6,6,6.6,7,8,8.4,9,10,12,14,16,20,25,30,40,50
4,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.0959,0.09215000000000001,0.0884,0.0839,0.08166,0.0783,0.07662,0.0749,0.0736,0.0729,0.0724,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072,0.072
5,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.0929,0.0802,0.0734,0.0658,0.0586,0.0532,0.0494,0.0478,0.0465,0.0459,0.0454,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453,0.0453
6,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.095,0.0841,0.0759,0.0682,0.0622,0.0573,0.0506,0.0469,0.0427,0.0385,0.0341,0.0316,0.0298,0.0286,0.0281,0.0278,0.0276,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275,0.0275
8,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.08,0.075,0.0692,0.0617,0.0558,0.0493,0.0421,0.0381,0.0357,0.0326,0.0285,0.025,0.0223,0.0201,0.0192,0.0182,0.0176,0.017,0.0163,0.0156,0.0145,0.0135,0.0125,0.0116,0.0108,0.00976,0.00913,0.0084,0.008,0.0076,0.0071,0.0068,0.006,0.005,0.0042,0.0035,0.0028,0.0022,0.0019,0.0016,0.0014,0.0012,0.0011
10,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.0964,0.089428571428571441,0.072,0.068573333333333319,0.063433333333333328,0.0463,0.0371,0.0316,0.0274,0.0244,0.022,0.0201,0.0186,0.0171,0.0152,0.0132,0.0116,0.0104,0.0091,0.0076,0.0067,0.0061,0.0055,0.0048,0.0045,0.0039,0.0034,0.0028,0.0023,0.0018,0.0014,0.0012,0.001,0.0008,0.0007,0.0006
15,0.0664,0.0626,0.055,0.044,0.0402,0.0354,0.0305,0.0289,0.0248,0.0201,0.0173,0.0154,0.0128,0.0111,0.00947,0.00832,0.00732,0.00609,0.00534,0.00485,0.0041,0.0038,0.0036,0.00311,0.00263,0.00223,0.00196,0.00169,0.00155,0.00144,0.00135,0.00124,0.00109,0.00096,0.00089,0.0008,0.00072,0.00063,0.00057,0.00052,0.000445,0.00041,0.00038,0.00034,0.00028,0.00023,0.00019,0.00015,0.00012,0.0001,8.96e-05,7.99e-05,7.24e-05,6.6e-05
20,0.0456,0.0422,0.0366,0.029,0.0264,0.0232,0.0199,0.0189,0.0163,0.0131,0.0111,0.0096,0.00792,0.00676,0.0057,0.00495,0.0043,0.00349,0.00305,0.00276,0.0023,0.0021,0.00196,0.00164,0.00136,0.00115,0.001,0.00086,0.000787,0.000727,0.000676,0.000613,0.000537,0.000465,0.000424,0.000386,0.00035,0.000302,0.000266,0.00024,0.00021,0.00018,0.00016,0.00015,0.00012,0.0001,8.23e-05,6.86e-05,5.64e-05,4.72e-05,4.14e-05,3.61e-05,3.23e-05,2.94e-05
25,0.0345,0.0315,0.0272,0.0215,0.0196,0.0173,0.0148,0.014,0.0121,0.00976,0.00832,0.0072,0.0059,0.00502,0.0042,0.00366,0.00317,0.0025,0.00215,0.00195,0.00162,0.00147,0.00136,0.00112,0.000925,0.00078,0.000678,0.00058,0.00052,0.00047,0.00043,0.000385,0.000335,0.000287,0.000259,0.000234,0.00021,0.00018,0.000156,0.00014,0.00012,0.0001,8.96e-05,8.12e-05,6.81e-05,5.43e-05,4.52e-05,3.71e-05,3.01e-05,2.44e-05,2.15e-05,1.89e-05,1.67e-05,1.51e-05
30,0.028,0.0256,0.0221,0.0175,0.0159,0.014,0.012,0.0114,0.0098,0.0079,0.0067,0.0058,0.00475,0.00405,0.00338,0.00293,0.00253,0.00201,0.00171,0.00155,0.00127,0.00116,0.00107,0.000863,0.00071,0.0006,0.00052,0.000445,0.000398,0.000361,0.000331,0.000298,0.000256,0.000218,0.000197,0.000177,0.000159,0.000135,0.000117,0.000105,9.08e-05,7.52e-05,6.72e-05,6.18e-05,5.16e-05,4.1e-05,3.37e-05,2.75e-05,2.2e-05,1.75e-05,1.52e-05,1.33e-05,1.17e-05,1.06e-05
40,0.0204,0.0186,0.016,0.0126,0.0115,0.0101,0.0086,0.0081,0.007,0.0056,0.0048,0.0041,0.0034,0.00285,0.00236,0.00204,0.00177,0.0014,0.0012,0.00107,0.000881,0.0008,0.00074,0.000595,0.000485,0.000408,0.000355,0.000302,0.00027,0.000245,0.000224,0.000202,0.000173,0.000146,0.000132,0.000118,0.000106,9.01e-05,7.74e-05,6.96e-05,6.01e-05,4.98e-05,4.42e-05,4.07e-05,3.36e-05,2.65e-05,2.16e-05,1.74e-05,1.36e-05,1.06e-05,9.22e-06,8.04e-06,7.09e-06,6.39e-06
50,0.0163,0.0148,0.0128,0.0101,0.0091,0.008,0.0068,0.0065,0.0055,0.0044,0.0038,0.0032,0.00262,0.00222,0.00185,0.0016,0.00138,0.00109,0.00093,0.000835,0.000685,0.00062,0.000572,0.000455,0.00037,0.00031,0.00027,0.000228,0.000203,0.000185,0.000169,0.000152,0.00013,0.00011,9.94e-05,8.88e-05,7.95e-05,6.66e-05,5.69e-05,5.1e-05,4.39e-05,3.61e-05,3.19e-05,2.94e-05,2.41e-05,1.88e-05,1.52e-05,1.22e-05,9.25e-06,7.08e-06,6.1e-06,5.3e-06,4.64e-06,4.19e-06
60,0.0137,0.0125,0.0107,0.0085,0.0077,0.0067,0.0058,0.0055,0.0047,0.0038,0.0032,0.0027,0.00222,0.00188,0.00155,0.00134,0.00116,0.000915,0.00078,0.0007,0.000572,0.00052,0.000479,0.000375,0.000305,0.000256,0.000222,0.000187,0.000166,0.000151,0.000138,0.000124,0.000106,8.96e-05,8.08e-05,7.2e-05,6.46e-05,5.35e-05,4.55e-05,4.06e-05,3.48e-05,2.85e-05,2.51e-05,2.3e-05,1.88e-05,1.46e-05,1.17e-05,9.26e-06,7.01e-06,5.32e-06,4.56e-06,3.95e-06,3.47e-06,3.12e-06
80,0.0097,0.0088,0.0076,0.006,0.0055,0.0048,0.0041,0.0038,0.0033,0.0026,0.0022,0.0019,0.00155,0.0013,0.00108,0.00093,0.0008,0.000625,0.00053,0.000475,0.000385,0.000349,0.00032,0.000249,0.000201,0.000168,0.000145,0.000122,0.000107,9.65e-05,8.78e-05,7.86e-05,6.72e-05,5.63e-05,5.04e-05,4.47e-05,4.01e-05,3.29e-05,2.78e-05,2.47e-05,2.1e-05,1.69e-05,1.48e-05,1.35e-05,1.1e-05,8.4e-06,6.6e-06,5.1e-06,3.7e-06,2.7e-06,2.2e-06,1.8e-06,1.6e-06,1.4e-06
100,0.0075,0.0067,0.0058,0.0046,0.0041,0.0036,0.0031,0.0029,0.0025,0.002,0.0017,0.0014,0.00115,0.00096,0.0008,0.00069,0.00059,0.00046,0.00039,0.000349,0.00028,0.000253,0.000232,0.00018,0.000146,0.000122,0.000105,8.8e-05,7.74e-05,6.96e-05,6.34e-05,5.65e-05,4.8e-05,4e-05,3.58e-05,3.17e-05,2.83e-05,2.31e-05,1.94e-05,1.72e-05,1.46e-05,1.16e-05,1.02e-05,9.26e-06,7.52e-06,5.65e-06,4.4e-06,3.4e-06,2.4e-06,1.7e-06,1.4e-06,1.1e-06,9.5e-07,8.2e-07
150,0.0044,0.004,0.0034,0.0027,0.0024,0.0021,0.0018,0.0017,0.0014,0.0011,0.00095,0.00081,0.00066,0.00055,0.00045,0.00039,0.00033,0.000255,0.000215,0.00019,0.00015,0.000135,0.000124,9.6e-05,7.7e-05,6.3e-05,5.4e-05,4.5e-05,3.95e-05,3.54e-05,3.22e-05,2.85e-05,2.4e-05,1.98e-05,1.77e-05,1.57e-05,1.38e-05,1.12e-05,9.3e-06,8.2e-06,6.9e-06,5.4e-06,4.7e-06,4.2e-06,3.4e-06,2.5e-06,1.9e-06,1.4e-06,9.5e-07,6.4e-07,5.1e-07,4.1e-07,3.5e-07,3.1e-07
200,0.003,0.0027,0.0023,0.0018,0.0017,0.0014,0.0012,0.0011,0.00095,0.00075,0.00064,0.00054,0.00043,0.00036,0.0003,0.00026,0.00022,0.00017,0.00014,0.00012,9.7e-05,8.7e-05,7.9e-05,6.1e-05,4.8e-05,3.9e-05,3.3e-05,2.7e-05,2.4e-05,2.1e-05,1.9e-05,1.6e-05,1.35e-05,1.12e-05,1e-05,8.8e-06,7.8e-06,6.2e-06,5.1e-06,4.5e-06,3.8e-06,2.9e-06,2.5e-06,2.2e-06,1.8e-06,1.3e-06,1e-06,7.2e-07,4.8e-07,3.1e-07,2.4e-07,1.9e-07,1.6e-07,1.4e-07
250,0.0022,0.002,0.0017,0.0013,0.0012,0.001,0.00086,0.0008,0.00067,0.00052,0.00044,0.00038,0.0003,0.00025,0.00021,0.00018,0.00015,0.00011,9.6e-05,8.4e-05,6.8e-05,6.1e-05,5.6e-05,4.3e-05,3.4e-05,2.75e-05,2.3e-05,1.9e-05,1.6e-05,1.4e-05,1.3e-05,1.1e-05,9.5e-06,7.8e-06,6.9e-06,6.1e-06,5.4e-06,4.3e-06,3.5e-06,3.1e-06,2.6e-06,2e-06,1.7e-06,1.5e-06,1.2e-06,9e-07,6.8e-07,5.2e-07,3.4e-07,2.1e-07,1.6e-07,1.2e-07,1.0e-07,8.5e-08
300,0.0017,0.0015,0.0013,0.001,0.00091,0.0008,0.00068,0.00064,0.00054,0.00042,0.00035,0.0003,0.00024,0.0002,0.00016,0.00014,0.00012,9.3e-05,7.7e-05,6.8e-05,5.5e-05,4.9e-05,4.5e-05,3.4e-05,2.7e-05,2.2e-05,1.8e-05,1.5e-05,1.3e-05,1.2e-05,1.1e-05,9.2e-06,7.8e-06,6.4e-06,5.6e-06,5e-06,4.4e-06,3.5e-06,2.8e-06,2.5e-06,2.1e-06,1.6e-06,1.3e-06,1.2e-06,9.5e-07,7.1e-07,5.3e-07,4.1e-07,2.7e-07,1.6e-07,1.2e-07,9.1e-08,7.6e-08,6.5e-08
400,0.0011,0.001,0.00085,0.00068,0.00061,0.00053,0.00046,0.00043,0.00036,0.00028,0.00024,0.0002,0.00016,0.00013,0.00011,9.4e-05,8e-05,6.2e-05,5.1e-05,4.5e-05,3.6e-05,3.2e-05,2.9e-05,2.2e-05,1.7e-05,1.4e-05,1.1e-05,9.2e-06,8e-06,7.1e-06,6.4e-06,5.5e-06,4.6e-06,3.7e-06,3.2e-06,2.8e-06,2.5e-06,2e-06,1.6e-06,1.4e-06,1.2e-06,9e-07,7.6e-07,6.7e-07,5.4e-07,3.9e-07,2.8e-07,2.1e-07,1.4e-07,8.6e-08,6.4e-08,4.9e-08,4.1e-08,3.5e-08
500,0.00083,0.00075,0.00064,0.0005,0.00045,0.0004,0.00034,0.00032,0.00027,0.00021,0.00017,0.00014,0.00011,9.4e-05,7.7e-05,6.6e-05,5.6e-05,4.3e-05,3.5e-05,3.1e-05,2.5e-05,2.2e-05,2e-05,1.5e-05,1.2e-05,9.8e-06,8.1e-06,6.7e-06,5.8e-06,5.1e-06,4.6e-06,3.9e-06,3.2e-06,2.6e-06,2.2e-06,2e-06,1.7e-06,1.3e-06,1.1e-06,9.5e-07,8.1e-07,6e-07,5e-07,4.4e-07,3.5e-07,2.5e-07,1.8e-07,1.3e-07,8.3e-08,5.1e-08,3.7e-08,2.8e-08,2.3e-08,2e-08
600,0.00066,0.0006,0.00052,0.0004,0.00036,0.00032,0.00027,0.00025,0.00021,0.00017,0.00014,0.00012,9.4e-05,7.8e-05,6.4e-05,5.5e-05,4.6e-05,3.5e-05,2.8e-05,2.5e-05,2e-05,1.8e-05,1.6e-05,1.2e-05,9.5e-06,7.8e-06,6.4e-06,5.2e-06,4.5e-06,4e-06,3.6e-06,3e-06,2.5e-06,2e-06,1.7e-06,1.5e-06,1.3e-06,1.1e-06,8.5e-07,7.2e-07,6.1e-07,4.5e-07,3.8e-07,3.3e-07,2.6e-07,1.8e-07,1.3e-07,9.1e-08,5.8e-08,3.5e-08,2.5e-08,1.9e-08,1.5e-08,1.3e-08
800,0.00045,0.00041,0.00035,0.00027,0.00025,0.00021,0.00018,0.00017,0.00014,0.00011,9e-05,7.5e-05,6.1e-05,5e-05,4.1e-05,3.5e-05,2.9e-05,2.2e-05,1.8e-05,1.6e-05,1.3e-05,1.1e-05,1e-05,7.5e-06,6e-06,4.8e-06,3.9e-06,3.1e-06,2.6e-06,2.3e-06,2.1e-06,1.7e-06,1.4e-06,1.1e-06,9e-07,8e-07,7e-07,5.5e-07,4.4e-07,3.8e-07,3.2e-07,2.3e-07,1.9e-07,1.7e-07,1.3e-07,9.2e-08,6.5e-08,4.5e-08,2.8e-08,1.7e-08,1.2e-08,9.1e-09,7.3e-09,6.2e-09
1000,0.00036,0.00032,0.00028,0.00021,0.00019,0.00017,0.00014,0.00013,0.00011,8.4e-05,7e-05,6e-05,4.8e-05,4e-05,3.3e-05,2.8e-05,2.3e-05,1.7e-05,1.4e-05,1.3e-05,1e-05,9e-06,8e-06,6e-06,4.7e-06,3.8e-06,3.1e-06,2.4e-06,2e-06,1.8e-06,1.6e-06,1.3e-06,1.1e-06,8.7e-07,7.2e-07,6.4e-07,5.5e-07,4.3e-07,3.4e-07,2.9e-07,2.4e-07,1.7e-07,1.4e-07,1.2e-07,9.5e-08,6.5e-08,4.5e-08,3.1e-08,1.9e-08,1.1e-08,8.2e-09,6.2e-09,5e-09,4.2e-09`;

        const factorB_cs1_csv_content = `temp-factor a,1.35e-05,1.43e-05,1.57e-05,1.78e-05,1.88e-05,0.000331,0.000367,0.0004,0.000413,0.0005,0.000513,0.0006,0.000645,0.0007,0.0008,0.0009,0.001,0.0015,0.002,0.0025,0.0095,0.0195,0.02,0.0212,0.0213,0.0225,0.1
300,200,211.6547901821061,232.05067300079176,262.64449722882028,277.21298495645289,4825.494853523358,5349.9604117181316,5830.7205067300083,6020.1108471892321,7287.56927949327,7476.9596199524949,8744.418052256533,9400,9900,10500,10900,11200,11900,12300,13100,13800,13800,13800,13800,13800,13800,13800
500,200,200,200,200,200,200,200,200,200,7000,7470,8100,8500,9350,9950,10300,10600,11300,11800,12300,13100,13100,13100,13100,13100,13100,13100
700,200,200,200,200,200,200,200,200,200,5130,5560,5800,6100,6300,6500,6650,7250,7600,8000,8600,9300,9800,10000,10300,10400,10600,11000
900,200,200,200,200,200,200,200,200,200,3200,3500,3700,3800,4000,4200,4300,4500,4700,4900,5300,5700,5900,6100,6200,6300,6400,6500
1100,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200
1300,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200
1500,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200`;

        const factorB_cs2_csv_content = `temp-factor a,1.76e-05,1.94e-05,2.13e-05,2.23e-05,2.37e-05,0.000428,0.000505,0.000564,0.000675,0.000783,0.0008,0.0009,0.001,0.0015,0.002,0.0025,0.003,0.004,0.005,0.008,0.01,0.015,0.02,0.025,0.0264,0.028,0.03,0.0319,0.1
300,250,275.98641233342045,303.41651424091975,317.85340998170886,338.0650640188137,6174.9020120198593,7286.542984060623,8138.3198327671817,9740.8152599947753,11300,11400,11800,12300,13650,15000,15600,16200,16800,17200,17260,17300,17400,17500,17600,17600,17600,17600,17600,17600
500,250,250,275.35845027455764,288.70500305064064,307.39017693715681,5703.4014643075052,6731.0860280658944,7518.53264185479,9000,9312,9361.1111111111113,9650,10000,10666.666666666666,11333.333333333334,12000,12600,13800,14800,16200,16900,17400,17600,17600,17600,17600,17600,17600,17600
700,250,250,250,275.98641233342045,303.41651424091975,5231.898860223751,6175.760126742918,6897.809315993605,8253.535948956666,8540,8625,8900,9170,9800,10400,11000,11500,12600,13500,14700,15400,16000,16600,17000,17200,17300,17400,17500,17600
900,250,250,250,250,250,250,250,250,250,6800,6900,7000,7200,7800,8300,8800,9200,10100,10800,11800,12300,12800,13200,13500,13600,13700,13800,13800,13800
1100,250,250,250,250,250,250,250,250,250,4900,5000,5100,5200,5600,6000,6400,6700,7300,7800,8500,8900,9300,9600,9800,9900,10000,10100,10200
1300,250,250,250,250,250,250,250,250,250,3000,3100,3200,3300,3600,3800,4000,4200,4500,4800,5300,5500,5800,6000,6100,6200,6300,6400,6500
1500,250,250,250,250,250,250,250,250,250,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000`;

        const factorB_ha1_csv_content = `temp-factor a,1.42e-05,1.59e-05,1.7e-05,1.81e-05,2e-05,0.0001,0.00011,0.000283,0.000312,0.000315,0.000338,0.000391,0.0004,0.000463,0.0005,0.0006,0.001,0.00127,0.0015,0.002,0.003,0.004,0.005,0.00506,0.006,0.01,0.02,0.04,0.0488,0.0538,0.0542,0.0631,0.0784,0.1
100,200,223.86363636363637,239.30481283422461,254.74598930481284,281.41711229946532,1404.4117647058824,1544.7860962566847,3973.2620320855613,4380.702282210356,4422.388835775401,4758.823529411765,5505.882352941177,5646.256684491979,6525.668449197861,7050.4010695187165,8454.438502673796,14138.823529411766,17950,21125,28000,32000,32000,32000,32000,32000,32000,32000,32000,32000,32000,32000,32000,32000,32000
300,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,10500,13100,15400,20200,28500,30500,31700,31800,32000,32000,32000,32000,32000,32000,32000,32000,32000,32000
500,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,7700,9600,11300,14900,20900,22500,23300,23400,23600,23900,24000,24000,24000,24000,24000,24000,24000,24000
700,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,5600,7000,8200,10800,15200,16300,17000,17100,17300,17500,17700,17700,17700,17700,17700,17700,17700,17700
900,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,4100,5200,6100,8000,11300,12100,12600,12700,12800,13000,13200,13200,13200,13200,13200,13200,13200,13200
1100,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,3000,3700,4300,5600,7900,8500,8800,8900,9000,9100,9300,9300,9300,9300,9300,9300,9300,9300
1300,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,2100,2600,3000,4000,5600,6000,6200,6300,6400,6500,6600,6600,6600,6600,6600,6600,6600,6600
1500,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,1500,1800,2200,2800,3900,4200,4300,4400,4500,4600,4700,4700,4700,4700,4700,4700,4700,4700`;

        // --- GLOBAL DATA STORE ---
        let factorA_Data = null;
        let factorB_Data = null;

        // --- EVENT LISTENERS ---
        document.getElementById('materialType').addEventListener('change', function() {
            updateMaterialInfo();
            const materialType = this.value;
            if (materialType) {
                loadFactorBData(materialType);
            } else {
                factorB_Data = null;
                updateStatus('B', 'Awaiting selection...', '');
            }
            checkCalculationReadiness();
        });

        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateFactors();
        });

        // --- DATA PARSING ---
        function parseCsvString(csvText, dataType) {
            try {
                const workbook = XLSX.read(csvText, { type: 'string' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
                if (!Array.isArray(json) || json.length < 2) {
                    throw new Error('Parsed data is empty or malformed. Expecting at least two rows of data.');
                }
                
                if (dataType === 'A') {
                    const ld_headers = json[0].slice(1).map(h => parseFloat(h));
                    const rows = json.slice(1).map(row => ({
                        dt: parseFloat(row[0]),
                        values: row.slice(1).map(v => parseFloat(v))
                    }));
                    return { ld_headers, rows };
                } else if (dataType === 'B') {
                    const factorA_headers = json[0].slice(1).map(h => parseFloat(h));
                    const rows = json.slice(1).map(row => ({
                        temp: parseFloat(row[0]),
                        values: row.slice(1).map(v => parseFloat(v))
                    }));
                    return { factorA_headers, rows };
                }
            } catch (error) {
                console.error(`Error parsing data for Factor ${dataType}:`, error);
                return null;
            }
        }
        
        function loadFactorBData(materialType) {
            let csvContent;
            switch (materialType) {
                case 'CS-1':
                    csvContent = factorB_cs1_csv_content;
                    break;
                case 'CS-2':
                    csvContent = factorB_cs2_csv_content;
                    break;
                case 'HA-1':
                    csvContent = factorB_ha1_csv_content;
                    break;
                default:
                    csvContent = null;
            }
            
            if (csvContent) {
                factorB_Data = parseCsvString(csvContent, 'B');
                if (factorB_Data) {
                    updateStatus('B', 'Loaded', 'loaded');
                } else {
                    updateStatus('B', 'Error parsing data', 'error');
                }
            } else {
                updateStatus('B', 'Awaiting selection...', '');
            }
        }

        // --- UI FUNCTIONS ---
        function updateStatus(type, text, className) {
            const statusElement = document.getElementById(`status${type}`);
            const prefix = `Factor ${type}: `;
            statusElement.textContent = prefix + text;
            statusElement.className = `file-status ${className}`;
        }
        
        function updateMaterialInfo() {
            const materialType = document.getElementById('materialType').value;
            const infoElement = document.getElementById('materialInfo');
            const materialInfos = {
                'CS-1': 'Standard carbon steel for general applications',
                'CS-2': 'Enhanced carbon steel for high-stress applications',
                'HA-1': 'High alloy steel for extreme conditions'
            };
            infoElement.textContent = materialInfos[materialType] || '';
        }

        function checkCalculationReadiness() {
            const materialType = document.getElementById('materialType').value;
            const calculateBtn = document.getElementById('calculateBtn');
            const isReady = factorA_Data && factorB_Data && materialType;
            calculateBtn.disabled = !isReady;
        }

        // --- MAIN CALCULATION CONTROLLER ---
        function calculateFactors() {
            const materialType = document.getElementById('materialType').value;
            const od = parseFloat(document.getElementById('outsideDiameter').value);
            const th = parseFloat(document.getElementById('thickness').value);
            const len = parseFloat(document.getElementById('length').value);
            const temp = parseFloat(document.getElementById('temperature').value);

            if (validateInputs(materialType, od, th, len, temp)) {
                const resultA = calculateFactorA(od, th, len);
                if (!resultA) return;

                const factors = calculateFactorB(materialType, resultA.factorA, temp);
                if (!factors) return;
                
                displayResults(materialType, od, th, len, temp, {
                    factorA: resultA.factorA,
                    factorB: factors.factorB,
                    dt_ratio: resultA.dt_ratio,
                    ld_ratio: resultA.ld_ratio
                });
            }
        }

        // --- CORE INTERPOLATION LOGIC ---
        function linearInterpolate(x, xp, fp) {
            if (x <= xp[0]) return fp[0];
            if (x >= xp[xp.length - 1]) return fp[xp.length - 1];
            let i = 1;
            while (xp[i] < x) i++;
            const x1 = xp[i - 1], y1 = fp[i - 1], x2 = xp[i], y2 = fp[i];
            return y1 + (y2 - y1) * ((x - x1) / (x2 - x1));
        }

        function interpolate2D(x, y, data) {
            const { x_headers, y_key, rows } = data;
            
            // Find the two rows to interpolate between based on the y-value
            const rowsSorted = [...rows].sort((a, b) => a[y_key] - b[y_key]);
            
            let y_upper_row = rowsSorted.find(row => row[y_key] >= y);
            let y_lower_row = rowsSorted.slice().reverse().find(row => row[y_key] <= y);
            
            if (!y_upper_row || !y_lower_row) {
                console.error("Could not find interpolation bounds for Y-value.");
                showWarning("Input value is outside the data range for interpolation.");
                return null;
            }

            const y1 = y_lower_row[y_key];
            const y2 = y_upper_row[y_key];

            // If the y-value is exactly one of the data points, no need for vertical interpolation
            if (y1 === y2 || y1 === y) {
                return linearInterpolate(x, x_headers, y_lower_row.values);
            }
            if (y2 === y) {
                return linearInterpolate(x, x_headers, y_upper_row.values);
            }

            // Interpolate the values for each x_header based on the y-value
            const interpolated_row_values = x_headers.map((_, i) => {
                const val1 = y_lower_row.values[i];
                const val2 = y_upper_row.values[i];
                return val1 + (val2 - val1) * ((y - y1) / (y2 - y1));
            });

            // Perform the final horizontal interpolation on the new row of values
            return linearInterpolate(x, x_headers, interpolated_row_values);
        }

        // --- MATERIAL-SPECIFIC CALCULATION FUNCTIONS ---
        function calculateFactorA(od, thickness, length) {
            let input_dt = od / thickness;
            let input_ld = length / od;
            
            if (input_ld < 0.05) input_ld = 0.05;
            if (input_ld > 50) input_ld = 50;
            if (input_dt < 4) input_dt = 4;
            if (input_dt > 1000) input_dt = 1000;

            if (!factorA_Data) {
                showWarning('Factor A data is not loaded.');
                return null;
            }

            const factorA_val = interpolate2D(input_ld, input_dt, {
                x_headers: factorA_Data.ld_headers,
                y_key: 'dt',
                rows: factorA_Data.rows
            });

            return {
                factorA: factorA_val,
                dt_ratio: input_dt,
                ld_ratio: input_ld
            };
        }

        function calculateFactorB(materialType, factorA_val, temperature) {
            if (!factorB_Data) {
                showWarning('Factor B data is not loaded.');
                return null;
            }
            
            // Correctly convert to Fahrenheit and handle boundaries
            let input_temp_f = (temperature * 9 / 5) + 32;

            if (materialType === 'CS-1' || materialType === 'CS-2') {
                if (input_temp_f < 300) input_temp_f = 300;
                if (input_temp_f > 900) input_temp_f = 900;
            } else if (materialType === 'HA-1') {
                if (input_temp_f < 100) input_temp_f = 100;
                if (input_temp_f > 1500) input_temp_f = 1500;
            }

            const factorB_raw = interpolate2D(factorA_val, input_temp_f, {
                x_headers: factorB_Data.factorA_headers,
                y_key: 'temp',
                rows: factorB_Data.rows
            });
            
            if (factorB_raw === null) return null;

            return {
                factorB: factorB_raw / 14.223
            };
        }

        // --- VALIDATION AND DISPLAY ---
        function validateInputs(materialType, od, thickness, length, temperature) {
            let isValid = true;
            let warningMessage = '';

            if (!materialType) {
                warningMessage = 'Please select a material type.';
                isValid = false;
            } else if (!factorA_Data || !factorB_Data) {
                 warningMessage = 'Data is still loading or failed to load. Please wait or check the console for errors.';
                isValid = false;
            } else if (od <= 0) {
                warningMessage = 'Outside diameter must be greater than 0.';
                isValid = false;
            } else if (thickness <= 0) {
                warningMessage = 'Thickness must be greater than 0.';
                isValid = false;
            } else if (thickness >= od / 2) {
                warningMessage = 'Thickness must be less than half the outside diameter.';
                isValid = false;
            } else if (length <= 0) {
                warningMessage = 'Length must be greater than 0.';
                isValid = false;
            } else if (isNaN(temperature)) {
                warningMessage = 'Please enter a valid temperature.';
                isValid = false;
            }

            if (!isValid) {
                showWarning(warningMessage);
                document.getElementById('results').classList.remove('show');
            } else {
                document.getElementById('warning').classList.remove('show');
            }

            return isValid;
        }
        
        function showWarning(message) {
            const warning = document.getElementById('warning');
            const warningText = document.getElementById('warningText');
            warningText.textContent = message;
            warning.classList.add('show');
        }

        function displayResults(materialType, od, th, len, temp, results) {
            document.getElementById('warning').classList.remove('show');
            
            // Update the main factor cards
            document.getElementById('factorAResult').textContent = results.factorA.toFixed(6);
            document.getElementById('factorBResult').textContent = results.factorB.toFixed(6);

            // Update the new results table
            document.getElementById('tableMaterial').textContent = materialType;
            document.getElementById('tableOD').textContent = od;
            document.getElementById('tableThickness').textContent = th;
            document.getElementById('tableLength').textContent = len;
            document.getElementById('tableTemperature').textContent = temp;
            document.getElementById('tableDTRatio').textContent = results.dt_ratio.toFixed(6);
            document.getElementById('tableLDRatio').textContent = results.ld_ratio.toFixed(6);
            document.getElementById('tableFactorA').textContent = results.factorA.toFixed(6);
            document.getElementById('tableFactorB').textContent = results.factorB.toFixed(6);

            document.getElementById('results').classList.add('show');
        }

        // --- INITIALIZATION ---
        function initialize() {
            // Parse Factor A data directly from the embedded string
            factorA_Data = parseCsvString(factorA_csv_content, 'A');
            checkCalculationReadiness();
            updateMaterialInfo();
        }

        // Start the application
        initialize();

    </script>
</body>
</html>
